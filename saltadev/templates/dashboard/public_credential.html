{% load static %}
<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Credencial de {{ credential_user.first_name }} {{ credential_user.last_name }} - SaltaDev</title>

  <!-- Open Graph / Social sharing -->
  <meta property="og:title" content="Credencial de {{ credential_user.first_name }} {{ credential_user.last_name }} - SaltaDev"/>
  <meta property="og:description" content="{{ credential_user.get_role_display }} de la comunidad SaltaDev"/>
  <meta property="og:type" content="profile"/>
  <meta property="og:url" content="{{ credential_url }}"/>
  {% if credential_profile.avatar_url %}
    <meta property="og:image" content="{{ credential_profile.avatar_url }}"/>
  {% endif %}

  {% include "includes/head.html" %}
  <link rel="stylesheet" href="{% static 'assets/css/base.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js" integrity="sha384-lELZMVO0WZSKHeOrm8rKLCq9ZXjY1+2I9uL/QyDxIXSd83b3/z5xBXb1uDoFi3P/" crossorigin="anonymous"></script> {# pragma: allowlist secret #}
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }
    .credential-pattern {
      background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%2394413d" fill-opacity="0.08"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
    }
  </style>
</head>
<body class="bg-background-dark text-white min-h-screen flex flex-col items-center justify-center p-4 selection:bg-primary selection:text-white font-display">

  <!-- Background decoration -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 -left-32 w-96 h-96 bg-primary/20 rounded-full blur-[150px]"></div>
    <div class="absolute bottom-1/4 -right-32 w-96 h-96 bg-primary/10 rounded-full blur-[150px]"></div>
  </div>

  <!-- Header -->
  <header class="relative z-10 text-center mb-8 animate-fade-in">
    <a href="{% url 'home' %}" class="inline-flex items-center gap-3 group">
      <img src="{% static 'assets/img/logo.webp' %}" alt="SaltaDev" class="size-12 object-contain"/>
      <div class="text-left">
        <h1 class="text-2xl font-bold text-white group-hover:text-primary transition-colors">SaltaDev</h1>
        <p class="text-xs text-[#8e8584]">Comunidad tech</p>
      </div>
    </a>
  </header>

  <!-- Credential Card -->
  <div class="relative z-10 w-full max-w-md animate-fade-in" style="animation-delay: 0.1s;">
    <div id="credentialCard" class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-[#1a1616] via-[#241f1e] to-[#1a1616] border border-[#3d2f2f] shadow-2xl credential-pattern">

      <!-- Header with gradient -->
      <div class="relative bg-gradient-to-r from-primary via-[#a04540] to-primary p-6 pb-16">
        <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.3) 10px, rgba(0,0,0,0.3) 20px);"></div>
        <div class="relative flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img src="{% static 'assets/img/logo.webp' %}" alt="SaltaDev" class="size-10 object-contain"/>
            <div>
              <h3 class="text-white font-bold text-lg tracking-tight" style="line-height: 1.2;">SaltaDev</h3>
              <p class="text-white/70 text-xs font-medium" style="line-height: 1.2;">Comunidad tech</p>
            </div>
          </div>
          {% if credential_user.email_confirmed %}
            <div class="flex items-center gap-1.5 bg-green-500/20 backdrop-blur px-3 rounded-full border border-green-500/30 whitespace-nowrap" style="height: 28px;">
              <svg class="w-3.5 h-3.5 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
              <span class="text-green-300 text-xs font-bold" style="line-height: 1;">Verificado</span>
            </div>
          {% else %}
            <div class="flex items-center gap-1.5 bg-yellow-500/20 backdrop-blur px-3 rounded-full border border-yellow-500/30 whitespace-nowrap" style="height: 28px;">
              <svg class="w-3.5 h-3.5 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
              <span class="text-yellow-300 text-xs font-bold" style="line-height: 1;">Pendiente</span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Avatar (overlapping) -->
      <div class="relative -mt-12 flex justify-center">
        <div class="size-24 rounded-2xl p-1 bg-gradient-to-br from-primary to-[#5a2321] shadow-xl ring-4 ring-[#241f1e]">
          {% if credential_profile.avatar_url %}
            <img src="{{ credential_profile.avatar_url }}" alt="{{ credential_user.first_name }}" class="w-full h-full rounded-xl object-cover"/>
          {% else %}
            <div class="w-full h-full rounded-xl bg-[#2a2424] flex items-center justify-center">
              <svg class="w-9 h-9 text-primary" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- User Info -->
      <div class="relative px-6 pt-4 pb-6 text-center">
        <div class="text-2xl font-bold text-white">{{ credential_user.first_name }} {{ credential_user.last_name }}</div>

        <!-- Role Badge -->
        <div class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full whitespace-nowrap
          {% if credential_user.role == 'administrador' %}
            bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-500/30
          {% elif credential_user.role == 'moderador' %}
            bg-gradient-to-r from-purple-500/20 to-violet-500/20 border border-purple-500/30
          {% elif credential_user.role == 'colaborador' %}
            bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30
          {% else %}
            bg-gradient-to-r from-primary/20 to-[#5a2321]/20 border border-primary/30
          {% endif %}
        ">
          {% if credential_user.role == 'administrador' %}
            <svg class="w-4 h-4 text-amber-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
            <span class="font-bold text-sm text-amber-300">{{ credential_user.get_role_display }}</span>
          {% elif credential_user.role == 'moderador' %}
            <svg class="w-4 h-4 text-purple-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"/><path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"/></svg>
            <span class="font-bold text-sm text-purple-300">{{ credential_user.get_role_display }}</span>
          {% elif credential_user.role == 'colaborador' %}
            <svg class="w-4 h-4 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            <span class="font-bold text-sm text-blue-300">{{ credential_user.get_role_display }}</span>
          {% else %}
            <svg class="w-4 h-4 text-primary flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="font-bold text-sm text-primary">{{ credential_user.get_role_display }}</span>
          {% endif %}
        </div>

        {% if credential_profile.dni %}
          <div class="mt-3 text-[#8e8584] text-sm font-medium">DNI: {{ credential_profile.dni }}</div>
        {% else %}
          <div class="mt-3 text-[#6b605f] text-sm italic">DNI no especificado</div>
        {% endif %}

        <!-- Divider -->
        <div class="my-5 h-px bg-gradient-to-r from-transparent via-[#3d2f2f] to-transparent"></div>

        <!-- Details Grid -->
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
            <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">ID Miembro</div>
            <div class="text-white font-bold font-mono">#{{ credential_user.public_id }}</div>
          </div>
          <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
            <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">Miembro desde</div>
            <div class="text-white font-bold font-mono">{{ credential_user.registered_at|date:"d/m/Y" }}</div>
          </div>
          {% if credential_user.province %}
            <div class="col-span-2 bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424] flex items-center gap-3 text-left">
              <svg class="w-5 h-5 text-primary flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
              <div>
                <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider">Ubicación</div>
                <div class="text-white font-medium">{{ credential_user.province.name }}, Argentina</div>
              </div>
            </div>
          {% endif %}
        </div>

        <!-- QR Code -->
        <div class="mt-5 flex items-center justify-center gap-4 p-4 bg-[#1d1919]/30 rounded-xl border border-[#2a2424]">
          <div class="w-20 h-20 bg-white rounded-lg p-1.5 flex items-center justify-center">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ credential_url|urlencode }}&bgcolor=ffffff&color=241f1e" alt="QR Code" class="w-full h-full"/>
          </div>
          <div class="text-left">
            <div class="text-[#8e8584] text-xs">Escaneá el código para</div>
            <div class="text-white font-bold text-sm">verificar esta credencial</div>
            <div class="text-[#6b605f] text-[10px] mt-1 font-mono">{{ credential_user.public_id }}</div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="bg-[#1a1616] border-t border-[#2a2424] px-6 py-3 flex items-center justify-center">
        <div class="flex items-center gap-1.5 text-white/70">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
          <div class="text-[10px] uppercase tracking-wider whitespace-nowrap">Credencial emitida: <span id="credentialTimestamp"></span></div>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="mt-6 flex items-center justify-center gap-3 animate-fade-in" style="animation-delay: 0.2s;">
      <button onclick="downloadCredential()" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-primary text-white rounded-xl font-bold text-sm hover:bg-primary-hover transition-colors shadow-lg hover:shadow-glow whitespace-nowrap h-12">
        <span class="material-symbols-outlined text-lg leading-none">download</span>
        <span>Descargar PNG</span>
      </button>
      <button onclick="shareCredential()" class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-[#2a2424] text-white rounded-xl font-bold text-sm hover:bg-[#3d3434] transition-colors border border-[#3d2f2f] whitespace-nowrap h-12">
        <span class="material-symbols-outlined text-lg leading-none">share</span>
        <span>Compartir</span>
      </button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="relative z-10 mt-8 text-center animate-fade-in" style="animation-delay: 0.3s;">
    <p class="text-[#6b605f] text-sm">
      <a href="{% url 'home' %}" class="hover:text-primary transition-colors">Conocé más sobre SaltaDev</a>
    </p>
  </footer>

  <script>
    // Set timestamp on page load
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const timestamp = now.toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }) + ' ' + now.toLocaleTimeString('es-AR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('credentialTimestamp').textContent = timestamp;
    });

    async function downloadCredential() {
      const card = document.getElementById('credentialCard');
      const button = event.currentTarget;
      const originalText = button.innerHTML;

      // Show loading state
      button.innerHTML = '<svg class="w-5 h-5 animate-spin inline-block" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/></svg> Generando...';
      button.disabled = true;

      try {
        // Wait for fonts to be ready
        await document.fonts.ready;

        const dataUrl = await htmlToImage.toPng(card, {
          pixelRatio: 3,
          backgroundColor: '#1a1616',
          cacheBust: true,
        });

        const link = document.createElement('a');
        link.download = 'credencial-saltadev-{{ credential_user.public_id }}.png';
        link.href = dataUrl;
        link.click();
      } catch (error) {
        console.error('Error generating image:', error);
        alert('Error al generar la imagen. Intentá de nuevo.');
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    function shareCredential() {
      const shareData = {
        title: 'Credencial SaltaDev - {{ credential_user.first_name }} {{ credential_user.last_name }}',
        text: 'Soy {{ credential_user.get_role_display }} de la comunidad SaltaDev!',
        url: '{{ credential_url }}'
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        navigator.clipboard.writeText('{{ credential_url }}').then(() => {
          alert('Link copiado al portapapeles');
        });
      }
    }
  </script>

</body>
</html>
