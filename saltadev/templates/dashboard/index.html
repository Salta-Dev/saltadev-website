{% load static %}
<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SaltaDev - Dashboard</title>
  {% include "includes/head.html" %}
  <link rel="stylesheet" href="{% static 'assets/css/base.css' %}">
  <style>
    .poncho-bg {
      background-color: #241f1e;
      background-image:
        linear-gradient(45deg, rgba(148, 65, 61, 0.03) 25%, transparent 25%, transparent 75%, rgba(148, 65, 61, 0.03) 75%, rgba(148, 65, 61, 0.03)),
        linear-gradient(45deg, rgba(148, 65, 61, 0.03) 25%, transparent 25%, transparent 75%, rgba(148, 65, 61, 0.03) 75%, rgba(148, 65, 61, 0.03));
      background-position: 0 0, 20px 20px;
      background-size: 40px 40px;
    }
    .poncho-accent {
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(148, 65, 61, 0.1) 0px,
        rgba(148, 65, 61, 0.1) 2px,
        transparent 2px,
        transparent 12px
      );
    }
    @keyframes zoom-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-in {
      animation: zoom-in 0.2s ease-out forwards;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen flex overflow-x-hidden selection:bg-primary selection:text-white font-display">

  {% include "dashboard/includes/sidebar.html" %}
  {% include "dashboard/includes/mobile_menu.html" %}

  <main class="flex-1 lg:ml-72 flex flex-col min-h-screen overflow-y-auto relative bg-background-dark">
    {% include "dashboard/includes/header.html" %}

    <div class="p-4 lg:p-8 max-w-[1600px] mx-auto w-full flex flex-col gap-6 lg:gap-8 pb-20">

      <!-- Profile & Credential Section -->
      <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-8">

        <!-- Profile Card -->
        <div class="xl:col-span-2 relative overflow-hidden rounded-2xl bg-surface-dark border border-[#2a2424] group">
          <div class="absolute top-0 right-0 w-64 h-64 bg-primary rounded-full blur-[100px] opacity-5 pointer-events-none"></div>

          <div class="relative z-10 p-5 lg:p-6 flex flex-col md:flex-row items-start gap-5 lg:gap-6">
            <!-- Avatar & Social Links -->
            <div class="flex-shrink-0 flex flex-col items-center gap-3">
              <div class="group-hover:scale-[1.02] transition-transform duration-500">
                <div class="size-24 md:size-28 lg:size-36 rounded-2xl p-1 bg-gradient-to-tr from-primary via-[#5a2321] to-[#241f1e] shadow-glow">
                  {% if profile.avatar_url %}
                    <img alt="{{ user.first_name }} {{ user.last_name }}" class="w-full h-full rounded-xl object-cover" src="{{ profile.avatar_url }}"/>
                  {% else %}
                    <div class="w-full h-full rounded-xl bg-[#2a2424] flex items-center justify-center">
                      <span class="material-symbols-outlined text-primary text-5xl">person</span>
                    </div>
                  {% endif %}
                </div>
              </div>
              <!-- Social Links -->
              <div class="flex items-center gap-2">
                {% if profile.github %}
                  <a href="{{ profile.github }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-white hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="GitHub">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                  </a>
                {% endif %}
                {% if profile.linkedin %}
                  <a href="{{ profile.linkedin }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-[#0077b5] hover:border-[#0077b5]/50 hover:bg-[#2a2424] transition-all" title="LinkedIn">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                  </a>
                {% endif %}
                {% if profile.twitter %}
                  <a href="https://x.com/{{ profile.twitter }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-white hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="X (Twitter)">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                  </a>
                {% endif %}
                {% if profile.website %}
                  <a href="{{ profile.website }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-primary hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="Sitio web">
                    <span class="material-symbols-outlined text-base">language</span>
                  </a>
                {% endif %}
                {% if not profile.github and not profile.linkedin and not profile.twitter and not profile.website %}
                  <a href="{% url 'profile_edit' %}" class="text-[#5a5050] text-xs hover:text-primary transition-colors">+ Redes</a>
                {% endif %}
              </div>
            </div>

            <!-- Info -->
            <div class="flex-1 flex flex-col h-full justify-between w-full">
              <div>
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                  <div>
                    <h3 class="text-2xl lg:text-3xl font-bold text-white">
                      {{ user.first_name }} {{ user.last_name }}
                    </h3>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                      {% if profile.technical_role %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">code</span>
                          {{ profile.get_technical_role_display }}
                        </span>
                      {% endif %}
                      {% if user.province %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">location_on</span>
                          {{ user.province.name }}
                        </span>
                      {% endif %}
                      {% if profile.company %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">apartment</span>
                          {{ profile.company }}
                        </span>
                      {% endif %}
                      {% if profile.phone %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">phone</span>
                          {{ profile.phone }}
                        </span>
                      {% endif %}
                      {% if profile.dni %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">badge</span>
                          DNI {{ profile.dni }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  <a href="{% url 'profile_edit' %}" class="flex items-center gap-2 px-4 py-2 bg-[#2a2424] hover:bg-primary/20 text-white rounded-lg text-sm font-medium transition-all border border-[#3d2f2f] hover:border-primary group">
                    <span class="material-symbols-outlined text-lg text-[#8e8584] group-hover:text-primary transition-colors">edit</span>
                    <span class="hidden sm:inline">Editar</span>
                  </a>
                </div>
                {% if profile.bio %}
                  <p class="text-[#8e8584] text-sm leading-relaxed max-w-2xl mt-3">
                    <span class="lg:hidden">{{ profile.bio|truncatewords:25 }}</span>
                    <span class="hidden lg:inline">{{ profile.bio|truncatechars:300 }}</span>
                  </p>
                {% else %}
                  <p class="text-[#5a5050] text-sm mt-3">
                    <a href="{% url 'profile_edit' %}" class="hover:text-primary transition-colors">+ Agregar biografía</a>
                  </p>
                {% endif %}
              </div>

              <!-- Technologies -->
              <div class="flex flex-wrap gap-1.5 mt-auto pt-4 border-t border-[#2a2424]">
                {% if profile.technologies %}
                  {% for tech in profile.technologies %}
                    <span class="px-2.5 py-1 rounded-md bg-primary/10 text-xs font-medium text-primary/90 hover:bg-primary/20 transition-colors cursor-default select-none">{{ tech }}</span>
                  {% endfor %}
                {% else %}
                  <a href="{% url 'profile_edit' %}" class="text-[#6b605f] text-xs hover:text-primary transition-colors">+ Agregar tecnologías</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Credential Card -->
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/90 to-[#5a2321]/90 backdrop-blur-xl border border-primary/30 text-white shadow-glow flex flex-col group">
          <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px);"></div>
          <div class="absolute -right-20 -top-20 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>

          <div class="relative z-10 p-6 flex flex-col h-full justify-between">
            <div class="flex justify-between items-start">
              <div class="flex flex-col gap-1">
                <span class="text-xs font-bold uppercase tracking-widest text-white/70">Credencial</span>
                <h3 class="text-2xl lg:text-3xl font-bold tracking-tight">{{ user.get_role_display }}</h3>
              </div>
              <div class="p-2 bg-white/10 rounded-lg backdrop-blur-md border border-white/10 shadow-lg">
                <span class="material-symbols-outlined text-white text-2xl lg:text-3xl">qr_code_2</span>
              </div>
            </div>

            <div class="mt-4 flex-1 flex flex-col justify-end">
              <div class="flex items-end justify-between mb-6">
                <div class="flex flex-col">
                  <span class="text-[10px] uppercase text-white/60 font-bold tracking-wider mb-1">Fecha de registro</span>
                  <span class="text-base lg:text-lg font-bold font-mono tracking-wide">{{ user.registered_at|date:"d/m/Y" }}</span>
                </div>
                <div class="flex flex-col items-end">
                  <span class="text-[10px] uppercase text-white/60 font-bold tracking-wider mb-1">ID #{{ user.public_id }}</span>
                  <div class="flex items-center gap-1">
                    {% if user.is_active %}
                      <span class="size-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_rgba(74,222,128,0.5)]"></span>
                      <span class="text-xs font-bold">Activo</span>
                    {% else %}
                      <span class="size-2 bg-red-400 rounded-full"></span>
                      <span class="text-xs font-bold">Inactivo</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="flex flex-col gap-3">
                <button onclick="openCredentialModal()" class="w-full py-3 px-4 bg-white text-primary rounded-xl font-bold text-sm hover:bg-white/90 transition-colors shadow-lg flex items-center justify-center gap-2 group/btn">
                  <span class="material-symbols-outlined text-[20px] group-hover/btn:scale-110 transition-transform">visibility</span>
                  Mostrar Credencial
                </button>
              </div>
            </div>
          </div>

          <div class="relative z-20 bg-black/20 backdrop-blur-md border-t border-white/10 px-6 py-3 flex items-center justify-between">
            <span class="text-[10px] font-medium text-white/60 uppercase tracking-wide">Descargar</span>
            <div class="flex items-center gap-2">
              <button class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/80 hover:text-white" title="Descargar JPG">
                <span class="material-symbols-outlined text-[20px]">image</span>
              </button>
              <button class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/80 hover:text-white" title="Descargar PDF">
                <span class="material-symbols-outlined text-[20px]">picture_as_pdf</span>
              </button>
              <div class="h-4 w-px bg-white/20 mx-1"></div>
              <button class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/80 hover:text-white" title="Compartir">
                <span class="material-symbols-outlined text-[20px]">share</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Benefits & Events Section -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 items-start">

        <!-- Benefits (placeholder for now) -->
        <div class="lg:col-span-2 flex flex-col gap-4 lg:gap-6">
          <div class="flex items-center justify-between px-1 border-l-4 border-primary pl-4">
            <h3 class="text-xl lg:text-2xl font-bold text-white flex items-center gap-2">
              Beneficios Exclusivos
            </h3>
            <a class="flex items-center gap-1 text-sm text-primary hover:text-primary-hover font-bold transition-colors group" href="#">
              Ver todos
              <span class="material-symbols-outlined text-[16px] group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </a>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 lg:gap-5">
            <!-- Placeholder: No benefits yet -->
            <div class="sm:col-span-2 xl:col-span-3 bg-[#241f1e] border border-[#342d2d] rounded-2xl p-8 text-center">
              <span class="material-symbols-outlined text-[#6b605f] text-5xl mb-4">card_giftcard</span>
              <h4 class="text-lg font-bold text-white mb-2">Próximamente</h4>
              <p class="text-sm text-[#8e8584]">Estamos trabajando en beneficios exclusivos para miembros de la comunidad.</p>
            </div>
          </div>
        </div>

        <!-- Upcoming Events -->
        <div class="flex flex-col gap-4 lg:gap-6">
          <div class="flex items-center justify-between px-1 border-l-4 border-primary pl-4">
            <h3 class="text-xl lg:text-2xl font-bold text-white flex items-center gap-2">
              Próximos Eventos
            </h3>
            <a href="{% url 'events' %}" class="size-8 rounded-full border border-[#342d2d] flex items-center justify-center hover:border-primary hover:bg-primary text-[#b2a5a4] hover:text-white transition-all">
              <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
            </a>
          </div>

          <div class="bg-surface-dark rounded-2xl border border-[#342d2d] p-2 flex flex-col gap-1 poncho-accent">
            {% if upcoming_events %}
              {% for event in upcoming_events %}
                <a href="{{ event.link }}" target="_blank" class="group p-3 rounded-xl hover:bg-[#2a2424] transition-colors flex gap-4 cursor-pointer border border-transparent hover:border-[#342d2d]">
                  <div class="flex flex-col items-center justify-center w-14 lg:w-16 h-14 lg:h-16 bg-primary rounded-xl text-white shadow-lg group-hover:scale-105 transition-transform shrink-0">
                    <span class="text-[10px] uppercase font-bold opacity-80">{{ event.event_start_date|date:"M" }}</span>
                    <span class="text-xl lg:text-2xl font-bold leading-none">{{ event.event_start_date|date:"d" }}</span>
                  </div>
                  <div class="flex-1 py-0.5 min-w-0">
                    <h4 class="font-bold text-white text-base lg:text-lg group-hover:text-primary transition-colors leading-tight truncate">{{ event.title }}</h4>
                    <div class="flex items-center gap-3 lg:gap-4 mt-2 flex-wrap">
                      {% if event.event_time_display %}
                        <div class="flex items-center gap-1.5 text-[#8e8584] text-xs">
                          <span class="material-symbols-outlined text-[14px]">schedule</span>
                          <span>{{ event.event_time_display }}</span>
                        </div>
                      {% endif %}
                      {% if event.location %}
                        <div class="flex items-center gap-1.5 text-[#8e8584] text-xs">
                          <span class="material-symbols-outlined text-[14px]">{% if 'online' in event.location|lower or 'virtual' in event.location|lower %}videocam{% else %}location_on{% endif %}</span>
                          <span class="truncate max-w-[100px]">{{ event.location }}</span>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </a>
                {% if not forloop.last %}
                  <div class="h-px bg-[#342d2d] mx-4"></div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="p-6 text-center">
                <span class="material-symbols-outlined text-[#6b605f] text-4xl mb-3">event_busy</span>
                <p class="text-sm text-[#8e8584]">No hay eventos próximos programados.</p>
                <a href="{% url 'events' %}" class="text-primary hover:text-primary-hover text-sm font-medium mt-2 inline-block">Ver todos los eventos</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Credential Modal -->
  <div id="credentialModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm overflow-y-auto" onclick="closeCredentialModal(event)">
    <div class="relative w-full max-w-md animate-in zoom-in-95 duration-200 my-8" onclick="event.stopPropagation()">
      <!-- Close button -->
      <button onclick="closeCredentialModal()" class="absolute -top-12 right-0 p-2 text-white/60 hover:text-white transition-colors">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>

      <!-- Credential Card -->
      <div id="credentialCard" class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-[#1a1616] via-[#241f1e] to-[#1a1616] border border-[#3d2f2f] shadow-2xl">
        <!-- Top decorative pattern -->
        <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%2394413d&quot; fill-opacity=&quot;0.08&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

        <!-- Header with gradient -->
        <div class="relative bg-gradient-to-r from-primary via-[#a04540] to-primary p-6 pb-16">
          <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.3) 10px, rgba(0,0,0,0.3) 20px);"></div>
          <div class="relative flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img src="{% static 'assets/img/logo.webp' %}" alt="SaltaDev" class="w-10 h-10 object-contain"/>
              <div>
                <div class="text-white font-bold text-lg tracking-tight">SaltaDev</div>
                <div class="text-white/70 text-xs font-medium">Comunidad de Desarrolladores</div>
              </div>
            </div>
            {% if user.email_confirmed %}
              <div class="flex items-center gap-1.5 bg-green-500/20 backdrop-blur px-3 py-1.5 rounded-full border border-green-500/30">
                <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                <span class="text-green-300 text-xs font-bold">Verificado</span>
              </div>
            {% else %}
              <div class="flex items-center gap-1.5 bg-yellow-500/20 backdrop-blur px-3 py-1.5 rounded-full border border-yellow-500/30">
                <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                <span class="text-yellow-300 text-xs font-bold">Pendiente</span>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Avatar (overlapping) -->
        <div class="relative -mt-12 flex justify-center">
          <div class="w-24 h-24 rounded-2xl p-1 bg-gradient-to-br from-primary to-[#5a2321] shadow-xl ring-4 ring-[#241f1e]">
            {% if profile.avatar_url %}
              <img src="{{ profile.avatar_url }}" alt="{{ user.first_name }}" class="w-full h-full rounded-xl object-cover"/>
            {% else %}
              <div class="w-full h-full rounded-xl bg-[#2a2424] flex items-center justify-center">
                <svg class="w-9 h-9 text-primary" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- User Info -->
        <div class="relative px-6 pt-4 pb-6 text-center">
          <div class="text-2xl font-bold text-white">{{ user.first_name }} {{ user.last_name }}</div>

          <!-- Role Badge -->
          <div class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full
            {% if user.role == 'administrador' %}
              bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-500/30
            {% elif user.role == 'moderador' %}
              bg-gradient-to-r from-purple-500/20 to-violet-500/20 border border-purple-500/30
            {% elif user.role == 'colaborador' %}
              bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30
            {% else %}
              bg-gradient-to-r from-primary/20 to-[#5a2321]/20 border border-primary/30
            {% endif %}
          ">
            {% if user.role == 'administrador' %}
              <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
              <span class="font-bold text-sm text-amber-300">{{ user.get_role_display }}</span>
            {% elif user.role == 'moderador' %}
              <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"/><path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"/></svg>
              <span class="font-bold text-sm text-purple-300">{{ user.get_role_display }}</span>
            {% elif user.role == 'colaborador' %}
              <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
              <span class="font-bold text-sm text-blue-300">{{ user.get_role_display }}</span>
            {% else %}
              <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              <span class="font-bold text-sm text-primary">{{ user.get_role_display }}</span>
            {% endif %}
          </div>

          {% if profile.dni %}
            <div class="mt-3 text-[#8e8584] text-sm font-medium">DNI: {{ profile.dni }}</div>
          {% else %}
            <div class="mt-3 text-[#6b605f] text-sm italic">DNI no especificado</div>
          {% endif %}

          <!-- Divider -->
          <div class="my-5 h-px bg-gradient-to-r from-transparent via-[#3d2f2f] to-transparent"></div>

          <!-- Details Grid -->
          <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
              <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">ID Miembro</div>
              <div class="text-white font-bold font-mono">#{{ user.public_id }}</div>
            </div>
            <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
              <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">Miembro desde</div>
              <div class="text-white font-bold font-mono">{{ user.registered_at|date:"d/m/Y" }}</div>
            </div>
            {% if user.province %}
              <div class="col-span-2 bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424] flex items-center gap-3 text-left">
                <svg class="w-5 h-5 text-primary flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <div>
                  <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider">Ubicación</div>
                  <div class="text-white font-medium">{{ user.province.name }}, Argentina</div>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- QR Code -->
          <div class="mt-5 flex items-center justify-center gap-4 p-4 bg-[#1d1919]/30 rounded-xl border border-[#2a2424]">
            <div class="w-20 h-20 bg-white rounded-lg p-1.5 flex items-center justify-center">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ credential_url|urlencode }}&bgcolor=ffffff&color=241f1e" alt="QR Code" class="w-full h-full"/>
            </div>
            <div class="text-left">
              <div class="text-[#8e8584] text-xs">Escaneá el código para</div>
              <div class="text-white font-bold text-sm">verificar esta credencial</div>
              <div class="text-[#6b605f] text-[10px] mt-1 font-mono">{{ user.public_id }}</div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="bg-[#1a1616] border-t border-[#2a2424] px-6 py-3 flex items-center justify-center">
          <div class="flex items-center gap-1.5 text-white/70">
            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
            <div class="text-[10px] uppercase tracking-wider whitespace-nowrap">Credencial emitida: <span id="credentialTimestamp"></span></div>
          </div>
        </div>
      </div>

      <!-- Action buttons below card -->
      <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-3">
        <button onclick="downloadCredential()" id="downloadBtn" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-white text-[#241f1e] rounded-xl font-bold text-sm hover:bg-white/90 transition-colors shadow-lg whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">download</span>
          <span>Descargar PNG</span>
        </button>
        <button onclick="shareCredential()" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-[#2a2424] text-white rounded-xl font-bold text-sm hover:bg-[#3d3434] transition-colors border border-[#3d2f2f] whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">share</span>
          <span>Compartir</span>
        </button>
        <a href="{{ credential_url }}" target="_blank" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-primary/20 text-primary rounded-xl font-bold text-sm hover:bg-primary/30 transition-colors border border-primary/30 whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">open_in_new</span>
          <span>Ver pública</span>
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <script>
    const CREDENTIAL_URL = '{{ credential_url }}';
    const USER_PUBLIC_ID = '{{ user.public_id }}';
    const USER_NAME = '{{ user.first_name }} {{ user.last_name }}';
    const USER_ROLE = '{{ user.get_role_display }}';

    function openCredentialModal() {
      const modal = document.getElementById('credentialModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';

      // Update timestamp
      const now = new Date();
      const timestamp = now.toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }) + ' ' + now.toLocaleTimeString('es-AR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('credentialTimestamp').textContent = timestamp;
    }

    function closeCredentialModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('credentialModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCredentialModal();
      }
    });

    async function downloadCredential() {
      const card = document.getElementById('credentialCard');
      const button = document.getElementById('downloadBtn');
      const originalHTML = button.innerHTML;

      // Show loading state
      button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/></svg> <span>Generando...</span>';
      button.disabled = true;

      try {
        // Wait for fonts to be ready
        await document.fonts.ready;

        const dataUrl = await htmlToImage.toPng(card, {
          pixelRatio: 3,
          backgroundColor: '#1a1616',
          cacheBust: true,
        });

        const link = document.createElement('a');
        link.download = `credencial-saltadev-${USER_PUBLIC_ID}.png`;
        link.href = dataUrl;
        link.click();
      } catch (error) {
        console.error('Error generating image:', error);
        alert('Error al generar la imagen. Intentá de nuevo.');
      } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
      }
    }

    function shareCredential() {
      const shareData = {
        title: `Credencial SaltaDev - ${USER_NAME}`,
        text: `Soy ${USER_ROLE} de la comunidad SaltaDev!`,
        url: CREDENTIAL_URL
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        navigator.clipboard.writeText(CREDENTIAL_URL).then(() => {
          alert('Link copiado al portapapeles');
        });
      }
    }
  </script>

</body>
</html>
