{% load static %}
<!DOCTYPE html>
<html class="dark" lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SaltaDev - Dashboard</title>
  {% include "includes/head.html" %}
  <link rel="stylesheet" href="{% static 'assets/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'assets/css/dashboard.css' %}">
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen flex overflow-x-hidden selection:bg-primary selection:text-white font-display">

  {% include "dashboard/includes/sidebar.html" %}
  {% include "dashboard/includes/mobile_menu.html" %}

  <main class="flex-1 lg:ml-72 flex flex-col min-h-screen overflow-y-auto relative bg-background-dark">
    {% include "dashboard/includes/header.html" %}

    <div class="p-4 lg:p-8 max-w-[1600px] mx-auto w-full flex flex-col gap-6 lg:gap-8 pb-20">

      {% if messages %}
        <div class="space-y-2">
          {% for message in messages %}
            {% if message.tags == 'success' %}
              <div class="rounded-lg border border-green-500/30 bg-green-500/10 p-4 text-sm text-green-300 flex items-center gap-3">
                <span class="material-symbols-outlined text-green-400">check_circle</span>
                {{ message }}
              </div>
            {% elif message.tags == 'error' %}
              <div class="rounded-lg border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-300 flex items-center gap-3">
                <span class="material-symbols-outlined text-red-400">error</span>
                {{ message }}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Profile & Credential Section -->
      <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 lg:gap-8">

        <!-- Profile Card -->
        <div class="xl:col-span-2 relative overflow-hidden rounded-2xl bg-surface-dark border border-[#2a2424] group">
          <div class="absolute top-0 right-0 w-64 h-64 bg-primary rounded-full blur-[100px] opacity-5 pointer-events-none"></div>

          <div class="relative z-10 p-5 lg:p-6 flex flex-col md:flex-row items-center md:items-start gap-5 lg:gap-6">
            <!-- Avatar & Social Links -->
            <div class="flex-shrink-0 flex flex-col items-center gap-3 w-full md:w-auto">
              <div class="group-hover:scale-[1.02] transition-transform duration-500">
                <div class="size-24 md:size-28 lg:size-36 rounded-2xl p-1 bg-gradient-to-tr from-primary via-[#5a2321] to-[#241f1e] shadow-glow">
                  {% if profile.avatar_url %}
                    <img alt="{{ user.first_name }} {{ user.last_name }}" class="w-full h-full rounded-xl object-cover" src="{{ profile.avatar_url }}"/>
                  {% else %}
                    <div class="w-full h-full rounded-xl bg-[#2a2424] flex items-center justify-center">
                      <span class="material-symbols-outlined text-primary text-5xl">person</span>
                    </div>
                  {% endif %}
                </div>
              </div>
              <!-- Social Links -->
              <div class="flex items-center gap-2">
                {% if profile.github %}
                  <a href="{{ profile.github_url }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-white hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="GitHub">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                  </a>
                {% endif %}
                {% if profile.linkedin %}
                  <a href="{{ profile.linkedin_url }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-[#0077b5] hover:border-[#0077b5]/50 hover:bg-[#2a2424] transition-all" title="LinkedIn">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                  </a>
                {% endif %}
                {% if profile.twitter %}
                  <a href="{{ profile.twitter_url }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-white hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="X (Twitter)">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                  </a>
                {% endif %}
                {% if profile.instagram %}
                  <a href="{{ profile.instagram_url }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-[#E4405F] hover:border-[#E4405F]/50 hover:bg-[#2a2424] transition-all" title="Instagram">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                  </a>
                {% endif %}
                {% if profile.discord %}
                  <a href="{{ profile.discord_url }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-[#5865F2] hover:border-[#5865F2]/50 hover:bg-[#2a2424] transition-all" title="Discord">
                    <svg class="size-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z"/></svg>
                  </a>
                {% endif %}
                {% if profile.website %}
                  <a href="{{ profile.website }}" target="_blank" rel="noopener noreferrer" class="size-8 rounded-lg bg-[#1d1919] border border-[#2a2424] flex items-center justify-center text-[#6b605f] hover:text-primary hover:border-primary/50 hover:bg-[#2a2424] transition-all" title="Sitio web">
                    <span class="material-symbols-outlined text-base">language</span>
                  </a>
                {% endif %}
                {% if not profile.has_social_links %}
                  <a href="{% url 'profile_edit' %}" class="text-[#5a5050] text-xs hover:text-primary transition-colors">+ Redes</a>
                {% endif %}
              </div>
            </div>

            <!-- Info -->
            <div class="flex-1 flex flex-col h-full justify-between w-full">
              <div>
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                  <div>
                    <h3 class="text-2xl lg:text-3xl font-bold text-white">
                      {{ user.first_name }} {{ user.last_name }}
                    </h3>
                    <div class="flex flex-wrap items-center gap-2 mt-2">
                      {% if profile.technical_role %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">code</span>
                          {{ profile.get_technical_role_display }}
                        </span>
                      {% endif %}
                      {% if user.province %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">location_on</span>
                          {{ user.province.name }}
                        </span>
                      {% endif %}
                      {% if profile.company %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">apartment</span>
                          {{ profile.company }}
                        </span>
                      {% endif %}
                      {% if profile.phone %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">phone</span>
                          {{ profile.phone }}
                        </span>
                      {% endif %}
                      {% if profile.dni %}
                        <span class="flex items-center gap-1.5 text-xs font-medium text-[#a09090] bg-[#1d1919]/80 px-2.5 py-1 rounded-full">
                          <span class="material-symbols-outlined text-sm text-primary">badge</span>
                          DNI {{ profile.dni }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  <a href="{% url 'profile_edit' %}" class="flex items-center gap-2 px-4 py-2 bg-[#2a2424] hover:bg-primary/20 text-white rounded-lg text-sm font-medium transition-all border border-[#3d2f2f] hover:border-primary group">
                    <span class="material-symbols-outlined text-lg text-[#8e8584] group-hover:text-primary transition-colors leading-none">edit</span>
                    <span>Editar perfil</span>
                  </a>
                </div>
                {% if profile.bio %}
                  <p class="text-[#8e8584] text-sm leading-relaxed max-w-2xl mt-3">
                    <span class="lg:hidden">{{ profile.bio|truncatewords:25 }}</span>
                    <span class="hidden lg:inline">{{ profile.bio|truncatechars:300 }}</span>
                  </p>
                {% else %}
                  <p class="text-[#5a5050] text-sm mt-3">
                    <a href="{% url 'profile_edit' %}" class="hover:text-primary transition-colors">+ Agregar biografía</a>
                  </p>
                {% endif %}
              </div>

              <!-- Technologies -->
              <div class="flex flex-wrap gap-1.5 mt-auto pt-4 border-t border-[#2a2424]">
                {% if profile.technologies %}
                  {% for tech in profile.technologies %}
                    <span class="px-2.5 py-1 rounded-md bg-primary/10 text-xs font-medium text-primary/90 hover:bg-primary/20 transition-colors cursor-default select-none">{{ tech }}</span>
                  {% endfor %}
                {% else %}
                  <a href="{% url 'profile_edit' %}" class="text-[#6b605f] text-xs hover:text-primary transition-colors">+ Agregar tecnologías</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Credential Card -->
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/90 to-[#5a2321]/90 backdrop-blur-xl border border-primary/30 text-white shadow-glow flex flex-col group">
          <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px);"></div>
          <div class="absolute -right-20 -top-20 w-64 h-64 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>

          <div class="relative z-10 p-6 flex flex-col h-full justify-between">
            <div class="flex justify-between items-start">
              <div class="flex flex-col gap-1">
                <span class="text-xs font-bold uppercase tracking-widest text-white/70">Credencial</span>
                <h3 class="text-2xl lg:text-3xl font-bold tracking-tight">{{ user.get_role_display }}</h3>
              </div>
              <div class="p-2 bg-white/10 rounded-lg backdrop-blur-md border border-white/10 shadow-lg">
                <span class="material-symbols-outlined text-white text-2xl lg:text-3xl">qr_code_2</span>
              </div>
            </div>

            <div class="mt-4 flex-1 flex flex-col justify-end">
              <div class="flex items-end justify-between mb-6">
                <div class="flex flex-col">
                  <span class="text-[10px] uppercase text-white/60 font-bold tracking-wider mb-1">Fecha de registro</span>
                  <span class="text-base lg:text-lg font-bold font-mono tracking-wide">{{ user.registered_at|date:"d/m/Y" }}</span>
                </div>
                <div class="flex flex-col items-end">
                  <span class="text-[10px] uppercase text-white/60 font-bold tracking-wider mb-1">ID #{{ user.public_id }}</span>
                  <div class="flex items-center gap-1">
                    {% if user.is_active %}
                      <span class="size-2 bg-green-400 rounded-full animate-pulse shadow-[0_0_10px_rgba(74,222,128,0.5)]"></span>
                      <span class="text-xs font-bold">Activo</span>
                    {% else %}
                      <span class="size-2 bg-red-400 rounded-full"></span>
                      <span class="text-xs font-bold">Inactivo</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="flex flex-col gap-3">
                <button onclick="openCredentialModal()" class="w-full py-3 px-4 bg-white text-primary rounded-xl font-bold text-sm hover:bg-white/90 transition-colors shadow-lg flex items-center justify-center gap-2 group/btn">
                  <span class="material-symbols-outlined text-[20px] group-hover/btn:scale-110 transition-transform">visibility</span>
                  Mostrar Credencial
                </button>
              </div>
            </div>
          </div>

          <div class="relative z-20 bg-black/20 backdrop-blur-md border-t border-white/10 px-6 py-3 flex items-center justify-between">
            <span class="text-[10px] font-medium text-white/60 uppercase tracking-wide">Acciones</span>
            <div class="flex items-center gap-2">
              <button onclick="openCredentialModal(); setTimeout(downloadCredential, 500);" class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/80 hover:text-white" title="Descargar PNG">
                <span class="material-symbols-outlined text-[20px]">download</span>
              </button>
              <div class="h-4 w-px bg-white/20 mx-1"></div>
              <button onclick="shareCredential()" class="p-2 hover:bg-white/10 rounded-lg transition-colors text-white/80 hover:text-white" title="Compartir">
                <span class="material-symbols-outlined text-[20px]">share</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Benefits & Events Section -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 items-start">

        <!-- Benefits -->
        <div class="lg:col-span-2 flex flex-col gap-4 lg:gap-6">
          <div class="flex items-center justify-between px-1 border-l-4 border-primary pl-4">
            <h3 class="text-xl lg:text-2xl font-bold text-white flex items-center gap-2">
              Beneficios Exclusivos
            </h3>
            <a class="flex items-center gap-1 text-sm text-primary hover:text-primary-hover font-bold transition-colors group" href="{% url 'benefits_list' %}">
              Ver todos
              <span class="material-symbols-outlined text-[16px] group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </a>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 lg:gap-5">
            {% if benefits %}
              {% for benefit in benefits %}
                <a href="{% url 'benefit_detail' pk=benefit.pk %}" class="group bg-surface-dark rounded-xl border border-[#342d2d] overflow-hidden hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:shadow-primary/10">
                  <!-- Image -->
                  <div class="aspect-[16/10] bg-[#1d1919] relative overflow-hidden">
                    {% if benefit.image %}
                      <img src="{{ benefit.image }}" alt="{{ benefit.title }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"/>
                    {% else %}
                      <div class="w-full h-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-4xl text-[#3d2f2f]">redeem</span>
                      </div>
                    {% endif %}
                    <!-- Badge -->
                    <div class="absolute top-2 left-2">
                      {% if benefit.benefit_type == 'discount' %}
                        <span class="px-2 py-0.5 rounded-full bg-green-600 text-white text-[10px] font-bold shadow-md">
                          {{ benefit.discount_percentage }}% OFF
                        </span>
                      {% else %}
                        <span class="px-2 py-0.5 rounded-full bg-blue-600 text-white text-[10px] font-bold shadow-md">
                          Canjeable
                        </span>
                      {% endif %}
                    </div>
                    <div class="absolute top-2 right-2 flex gap-1">
                      {% if benefit.modality == 'virtual' %}
                        <span class="px-2 py-0.5 rounded-full bg-purple-600 text-white text-[10px] font-bold shadow-md">Virtual</span>
                      {% elif benefit.modality == 'in_person' %}
                        <span class="px-2 py-0.5 rounded-full bg-amber-600 text-white text-[10px] font-bold shadow-md">Presencial</span>
                      {% elif benefit.modality == 'both' %}
                        <span class="px-2 py-0.5 rounded-full bg-indigo-600 text-white text-[10px] font-bold shadow-md">Virtual y Presencial</span>
                      {% endif %}
                      {% if benefit.is_expired %}
                        <span class="px-2 py-0.5 rounded-full bg-red-600 text-white text-[10px] font-bold shadow-md">Expirado</span>
                      {% endif %}
                    </div>
                  </div>
                  <!-- Content -->
                  <div class="p-4">
                    <h4 class="font-bold text-white text-sm group-hover:text-primary transition-colors line-clamp-1">{{ benefit.title }}</h4>
                    <p class="text-[#8e8584] text-xs line-clamp-2 mt-1">{{ benefit.description }}</p>
                  </div>
                </a>
              {% endfor %}
            {% else %}
              <!-- Empty state -->
              <div class="sm:col-span-2 xl:col-span-3 bg-[#241f1e] border border-[#342d2d] rounded-2xl p-8 text-center">
                <span class="material-symbols-outlined text-[#6b605f] text-5xl mb-4">card_giftcard</span>
                <h4 class="text-lg font-bold text-white mb-2">Sin beneficios disponibles</h4>
                <p class="text-sm text-[#8e8584]">Todavía no hay beneficios publicados.</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Upcoming Events -->
        <div class="flex flex-col gap-4 lg:gap-6">
          <div class="flex items-center justify-between px-1 border-l-4 border-primary pl-4">
            <h3 class="text-xl lg:text-2xl font-bold text-white flex items-center gap-2">
              Próximos Eventos
            </h3>
            <a href="{% url 'events' %}" class="size-8 rounded-full border border-[#342d2d] flex items-center justify-center hover:border-primary hover:bg-primary text-[#b2a5a4] hover:text-white transition-all">
              <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
            </a>
          </div>

          <div class="bg-surface-dark rounded-2xl border border-[#342d2d] p-2 flex flex-col gap-1 poncho-accent">
            {% if upcoming_events %}
              {% for event in upcoming_events %}
                <a href="{{ event.link }}" target="_blank" class="group p-3 rounded-xl hover:bg-[#2a2424] transition-colors flex gap-4 cursor-pointer border border-transparent hover:border-[#342d2d]">
                  <div class="flex flex-col items-center justify-center w-14 lg:w-16 h-14 lg:h-16 bg-primary rounded-xl text-white shadow-lg group-hover:scale-105 transition-transform shrink-0">
                    <span class="text-[10px] uppercase font-bold opacity-80">{{ event.event_start_date|date:"M" }}</span>
                    <span class="text-xl lg:text-2xl font-bold leading-none">{{ event.event_start_date|date:"d" }}</span>
                  </div>
                  <div class="flex-1 py-0.5 min-w-0">
                    <h4 class="font-bold text-white text-base lg:text-lg group-hover:text-primary transition-colors leading-tight truncate">{{ event.title }}</h4>
                    <div class="flex items-center gap-3 lg:gap-4 mt-2 flex-wrap">
                      {% if event.event_time_display %}
                        <div class="flex items-center gap-1.5 text-[#8e8584] text-xs">
                          <span class="material-symbols-outlined text-[14px]">schedule</span>
                          <span>{{ event.event_time_display }}</span>
                        </div>
                      {% endif %}
                      {% if event.location %}
                        <div class="flex items-center gap-1.5 text-[#8e8584] text-xs">
                          <span class="material-symbols-outlined text-[14px]">{% if 'online' in event.location|lower or 'virtual' in event.location|lower %}videocam{% else %}location_on{% endif %}</span>
                          <span class="truncate max-w-[100px]">{{ event.location }}</span>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </a>
                {% if not forloop.last %}
                  <div class="h-px bg-[#342d2d] mx-4"></div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="p-6 text-center">
                <span class="material-symbols-outlined text-[#6b605f] text-4xl mb-3">event_busy</span>
                <p class="text-sm text-[#8e8584]">No hay eventos próximos programados.</p>
                <a href="{% url 'events' %}" class="text-primary hover:text-primary-hover text-sm font-medium mt-2 inline-block">Ver todos los eventos</a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Credential Modal -->
  <div id="credentialModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm overflow-y-auto" onclick="closeCredentialModal(event)">
    <div class="relative w-full max-w-md animate-in zoom-in-95 duration-200 my-8" onclick="event.stopPropagation()">
      <!-- Close button -->
      <button onclick="closeCredentialModal()" class="absolute -top-12 right-0 p-2 text-white/60 hover:text-white transition-colors">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>

      <!-- Credential Card -->
      <div id="credentialCard" class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-[#1a1616] via-[#241f1e] to-[#1a1616] border border-[#3d2f2f] shadow-2xl">
        <!-- Top decorative pattern -->
        <div class="absolute inset-0 opacity-30 pointer-events-none" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%2394413d&quot; fill-opacity=&quot;0.08&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

        <!-- Header with gradient -->
        <div class="relative bg-gradient-to-r from-primary via-[#a04540] to-primary p-6 pb-16">
          <div class="absolute inset-0 opacity-20" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.3) 10px, rgba(0,0,0,0.3) 20px);"></div>
          <div class="relative flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img src="{% static 'assets/img/logo.webp' %}" alt="SaltaDev" class="w-10 h-10 object-contain"/>
              <div>
                <div class="text-white font-bold text-lg tracking-tight">SaltaDev</div>
                <div class="text-white/70 text-xs font-medium">Comunidad de Desarrolladores</div>
              </div>
            </div>
            {% if user.email_confirmed %}
              <div class="flex items-center gap-1.5 bg-green-500/20 backdrop-blur px-3 py-1.5 rounded-full border border-green-500/30">
                <svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                <span class="text-green-300 text-xs font-bold">Verificado</span>
              </div>
            {% else %}
              <div class="flex items-center gap-1.5 bg-yellow-500/20 backdrop-blur px-3 py-1.5 rounded-full border border-yellow-500/30">
                <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                <span class="text-yellow-300 text-xs font-bold">Pendiente</span>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Avatar (overlapping) -->
        <div class="relative -mt-12 flex justify-center">
          <div class="w-24 h-24 rounded-2xl p-1 bg-gradient-to-br from-primary to-[#5a2321] shadow-xl ring-4 ring-[#241f1e]">
            {% if profile.avatar_url %}
              <img src="{{ profile.avatar_url }}" alt="{{ user.first_name }}" class="w-full h-full rounded-xl object-cover"/>
            {% else %}
              <div class="w-full h-full rounded-xl bg-[#2a2424] flex items-center justify-center">
                <svg class="w-9 h-9 text-primary" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- User Info -->
        <div class="relative px-6 pt-4 pb-6 text-center">
          <div class="text-2xl font-bold text-white">{{ user.first_name }} {{ user.last_name }}</div>

          <!-- Role Badge -->
          <div class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-full
            {% if user.role == 'administrador' %}
              bg-gradient-to-r from-amber-500/20 to-yellow-500/20 border border-amber-500/30
            {% elif user.role == 'moderador' %}
              bg-gradient-to-r from-purple-500/20 to-violet-500/20 border border-purple-500/30
            {% elif user.role == 'colaborador' %}
              bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30
            {% else %}
              bg-gradient-to-r from-primary/20 to-[#5a2321]/20 border border-primary/30
            {% endif %}
          ">
            {% if user.role == 'administrador' %}
              <svg class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
              <span class="font-bold text-sm text-amber-300">{{ user.get_role_display }}</span>
            {% elif user.role == 'moderador' %}
              <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17 11c.34 0 .67.04 1 .09V6.27L10.5 3 3 6.27v4.91c0 4.54 3.2 8.79 7.5 9.82.55-.13 1.08-.32 1.6-.55-.69-.98-1.1-2.17-1.1-3.45 0-3.31 2.69-6 6-6z"/><path d="M17 13c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 1.38c.62 0 1.12.51 1.12 1.12s-.51 1.12-1.12 1.12-1.12-.51-1.12-1.12.5-1.12 1.12-1.12zm0 5.37c-.93 0-1.74-.46-2.24-1.17.05-.72 1.51-1.08 2.24-1.08s2.19.36 2.24 1.08c-.5.71-1.31 1.17-2.24 1.17z"/></svg>
              <span class="font-bold text-sm text-purple-300">{{ user.get_role_display }}</span>
            {% elif user.role == 'colaborador' %}
              <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
              <span class="font-bold text-sm text-blue-300">{{ user.get_role_display }}</span>
            {% else %}
              <svg class="w-4 h-4 text-primary" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              <span class="font-bold text-sm text-primary">{{ user.get_role_display }}</span>
            {% endif %}
          </div>

          {% if profile.dni %}
            <div class="mt-3 text-[#8e8584] text-sm font-medium">DNI: {{ profile.dni }}</div>
          {% else %}
            <div class="mt-3 text-[#6b605f] text-sm italic">DNI no especificado</div>
          {% endif %}

          <!-- Divider -->
          <div class="my-5 h-px bg-gradient-to-r from-transparent via-[#3d2f2f] to-transparent"></div>

          <!-- Details Grid -->
          <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
              <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">ID Miembro</div>
              <div class="text-white font-bold font-mono">#{{ user.public_id }}</div>
            </div>
            <div class="bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424]">
              <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider mb-1">Miembro desde</div>
              <div class="text-white font-bold font-mono">{{ user.registered_at|date:"d/m/Y" }}</div>
            </div>
            {% if user.province %}
              <div class="col-span-2 bg-[#1d1919]/50 rounded-xl p-3 border border-[#2a2424] flex items-center gap-3 text-left">
                <svg class="w-5 h-5 text-primary flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                <div>
                  <div class="text-[10px] uppercase text-[#6b605f] font-bold tracking-wider">Ubicación</div>
                  <div class="text-white font-medium">{{ user.province.name }}, Argentina</div>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- QR Code -->
          <div class="mt-5 flex items-center justify-center gap-4 p-4 bg-[#1d1919]/30 rounded-xl border border-[#2a2424]">
            <div class="w-20 h-20 bg-white rounded-lg p-1.5 flex items-center justify-center">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data={{ credential_url|urlencode }}&bgcolor=ffffff&color=241f1e" alt="QR Code" class="w-full h-full"/>
            </div>
            <div class="text-left">
              <div class="text-[#8e8584] text-xs">Escaneá el código para</div>
              <div class="text-white font-bold text-sm">verificar esta credencial</div>
              <div class="text-[#6b605f] text-[10px] mt-1 font-mono">{{ user.public_id }}</div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="bg-[#1a1616] border-t border-[#2a2424] px-6 py-3 flex items-center justify-center">
          <div class="flex items-center gap-1.5 text-white/70">
            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
            <div class="text-[10px] uppercase tracking-wider whitespace-nowrap">Credencial emitida: <span id="credentialTimestamp"></span></div>
          </div>
        </div>
      </div>

      <!-- Action buttons below card -->
      <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-3">
        <button onclick="downloadCredential()" id="downloadBtn" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-white text-[#241f1e] rounded-xl font-bold text-sm hover:bg-white/90 transition-colors shadow-lg whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">download</span>
          <span>Descargar PNG</span>
        </button>
        <button onclick="shareCredential()" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-[#2a2424] text-white rounded-xl font-bold text-sm hover:bg-[#3d3434] transition-colors border border-[#3d2f2f] whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">share</span>
          <span>Compartir</span>
        </button>
        <a href="{{ credential_url }}" target="_blank" class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-primary/20 text-primary rounded-xl font-bold text-sm hover:bg-primary/30 transition-colors border border-primary/30 whitespace-nowrap h-11">
          <span class="material-symbols-outlined text-lg leading-none">open_in_new</span>
          <span>Ver pública</span>
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js" integrity="sha384-lELZMVO0WZSKHeOrm8rKLCq9ZXjY1+2I9uL/QyDxIXSd83b3/z5xBXb1uDoFi3P/" crossorigin="anonymous"></script> {# pragma: allowlist secret #}
  <script>
    const CREDENTIAL_URL = '{{ credential_url }}';
    const USER_PUBLIC_ID = '{{ user.public_id }}';
    const USER_NAME = '{{ user.first_name }} {{ user.last_name }}';
    const USER_ROLE = '{{ user.get_role_display }}';

    function openCredentialModal() {
      const modal = document.getElementById('credentialModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';

      // Update timestamp
      const now = new Date();
      const timestamp = now.toLocaleDateString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }) + ' ' + now.toLocaleTimeString('es-AR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('credentialTimestamp').textContent = timestamp;
    }

    function closeCredentialModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const modal = document.getElementById('credentialModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      document.body.style.overflow = '';
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeCredentialModal();
      }
    });

    async function downloadCredential() {
      const card = document.getElementById('credentialCard');
      const button = document.getElementById('downloadBtn');
      const originalHTML = button.innerHTML;

      // Show loading state
      button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8Z"/></svg> <span>Generando...</span>';
      button.disabled = true;

      try {
        // Wait for fonts to be ready
        await document.fonts.ready;

        const dataUrl = await htmlToImage.toPng(card, {
          pixelRatio: 3,
          backgroundColor: '#1a1616',
          cacheBust: true,
        });

        const link = document.createElement('a');
        link.download = `credencial-saltadev-${USER_PUBLIC_ID}.png`;
        link.href = dataUrl;
        link.click();
      } catch (error) {
        console.error('Error generating image:', error);
        alert('Error al generar la imagen. Intentá de nuevo.');
      } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
      }
    }

    function shareCredential() {
      const shareData = {
        title: `Credencial SaltaDev - ${USER_NAME}`,
        text: `Soy ${USER_ROLE} de la comunidad SaltaDev!`,
        url: CREDENTIAL_URL
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        navigator.clipboard.writeText(CREDENTIAL_URL).then(() => {
          alert('Link copiado al portapapeles');
        });
      }
    }
  </script>

</body>
</html>
